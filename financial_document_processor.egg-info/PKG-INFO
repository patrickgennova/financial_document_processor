Metadata-Version: 2.4
Name: financial-document-processor
Version: 0.1.0
Summary: MicroserviÃ§o para processamento de documentos financeiros com IA
Author: Seu Nome
Author-email: Seu Nome <seu.email@exemplo.com>
License: MIT
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.10
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: aiokafka>=0.8.0
Requires-Dist: pydantic>=2.0.0
Requires-Dist: python-dotenv>=1.1.0
Requires-Dist: loguru>=0.7.0
Requires-Dist: httpx>=0.24.0
Requires-Dist: sqlalchemy>=2.0.0
Requires-Dist: psycopg2-binary>=2.9.5
Requires-Dist: asyncpg>=0.27.0
Requires-Dist: openai>=1.0.0
Requires-Dist: google-generativeai>=0.3.0
Requires-Dist: anthropic>=0.5.0
Requires-Dist: pypdf>=3.15.1
Requires-Dist: pytesseract>=0.3.10
Requires-Dist: tenacity>=8.2.0
Requires-Dist: prometheus-client>=0.17.0
Requires-Dist: alembic>=1.10.0
Provides-Extra: dev
Requires-Dist: pytest>=7.0.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.20.0; extra == "dev"
Requires-Dist: pytest-cov>=4.0.0; extra == "dev"
Requires-Dist: black>=23.0.0; extra == "dev"
Requires-Dist: isort>=5.12.0; extra == "dev"
Requires-Dist: mypy>=1.0.0; extra == "dev"
Requires-Dist: ruff>=0.0.260; extra == "dev"
Dynamic: author
Dynamic: requires-python

# Financial Document Processor

[![Python Version](https://img.shields.io/badge/python-3.10-blue.svg)](https://www.python.org/downloads/release/python-3100/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

Um microserviÃ§o eficiente para processamento de documentos financeiros usando InteligÃªncia Artificial.

## ğŸ“‹ VisÃ£o Geral

O Financial Document Processor Ã© um microserviÃ§o Python que:

1. Consome mensagens do Kafka contendo documentos financeiros (em base64)
2. Decodifica e extrai texto desses documentos (extratos bancÃ¡rios, etc.)
3. Utiliza IA para extrair transaÃ§Ãµes e categorizÃ¡-las com alta precisÃ£o
4. Persiste os resultados e notifica sistemas downstream via Kafka

Suas principais caracterÃ­sticas incluem:

- **Arquitetura plugÃ¡vel de IA**: Alternar facilmente entre OpenAI, Gemini e Claude
- **Alto desempenho**: Processamento eficiente e otimizado para custo
- **SeguranÃ§a e confiabilidade**: Design robusto para dados financeiros confidenciais
- **Escalabilidade**: Arquitetura totalmente assÃ­ncrona e pronta para horizontalizaÃ§Ã£o
- **Observabilidade**: Logging detalhado e mÃ©tricas Prometheus

## ğŸ—ï¸ Arquitetura

Este projeto segue os princÃ­pios da Arquitetura Hexagonal (Ports & Adapters):

```
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚                                  â”‚
                       â”‚          Domain Core             â”‚
                       â”‚                                  â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                     â”‚                                     â”‚
â”‚           Input Adapters            â”‚         Output Adapters             â”‚
â”‚                                     â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚ â”‚ â”‚              â”‚  â”‚              â”‚  â”‚
â”‚  â”‚    Kafka     â”‚  â”‚    HTTP      â”‚ â”‚ â”‚   Database   â”‚  â”‚    Kafka     â”‚  â”‚
â”‚  â”‚   Consumer   â”‚  â”‚     API      â”‚ â”‚ â”‚              â”‚  â”‚   Producer   â”‚  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚ â”‚ â”‚              â”‚  â”‚              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    â”‚â”‚â”‚                                    â”‚
â”‚          AI Providers              â”‚â”‚â”‚       External Services            â”‚
â”‚                                    â”‚â”‚â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              â”‚  â”‚              â”‚â”‚â”‚â”‚  â”‚              â”‚  â”‚              â”‚â”‚
â”‚  â”‚    OpenAI    â”‚  â”‚    Gemini    â”‚â”‚â”‚â”‚  â”‚  Monitoring  â”‚  â”‚    Tracing   â”‚â”‚
â”‚  â”‚              â”‚  â”‚              â”‚â”‚â”‚â””â”€â–ºâ”‚              â”‚  â”‚              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                    â”‚â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚â”‚                                     â”‚
â”‚  â”‚              â”‚                  â”‚â”‚                                     â”‚
â”‚  â”‚    Claude    â”‚                  â”‚â”‚                                     â”‚
â”‚  â”‚              â”‚                  â”‚â”‚                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚â”‚                                     â”‚
â”‚                                    â”‚â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ InstruÃ§Ãµes de InstalaÃ§Ã£o

### PrÃ©-requisitos

- Python 3.10+
- Docker e Docker Compose
- Acesso a um cluster Kafka
- Credenciais para APIs de IA (OpenAI, Gemini, Claude)

### InstalaÃ§Ã£o com Docker Compose

1. Clone o repositÃ³rio:
   ```bash
   git clone https://github.com/seu-usuario/financial-document-processor.git
   cd financial-document-processor
   ```

2. Configure suas variÃ¡veis de ambiente:
   ```bash
   cp .env.example .env
   # Edite o arquivo .env com suas credenciais
   ```

3. Inicie os serviÃ§os:
   ```bash
   docker-compose up -d
   ```

### InstalaÃ§Ã£o Manual

1. Clone o repositÃ³rio:
   ```bash
   git clone https://github.com/seu-usuario/financial-document-processor.git
   cd financial-document-processor
   ```

2. Configure o ambiente virtual:
   ```bash
   python -m venv venv
   source venv/bin/activate  # No Windows: venv\Scripts\activate
   ```

3. Instale as dependÃªncias:
   ```bash
   pip install -e .
   ```

4. Configure suas variÃ¡veis de ambiente:
   ```bash
   cp .env.example .env
   # Edite o arquivo .env com suas credenciais
   ```

5. Execute o serviÃ§o:
   ```bash
   python -m financial_document_processor.main
   ```

## ğŸ“ Uso e ConfiguraÃ§Ã£o

### Formato da Mensagem Kafka

O serviÃ§o espera mensagens no seguinte formato JSON:

```json
{
  "id": 12345,
  "external_id": "44f437b5-a093-4a53-bc59-dd427f8e9c56",
  "user_id": 98765,
  "document_type": "bank_statement",
  "filename": "extrato-maio-2023.pdf",
  "content_type": "application/pdf",
  "file_content": "base64_encoded_string_here...",
  "categories": ["categoria1", "categoria2"],
  "status": "pending",
  "created_at": "2023-05-10T14:30:00Z",
  "updated_at": "2023-05-10T14:30:00Z"
}
```

Campos importantes:
- `document_type`: Tipo de documento (atualmente suporta "bank_statement")
- `file_content`: ConteÃºdo do arquivo em Base64
- `content_type`: MIME type do arquivo (application/pdf, image/jpeg, etc.)
- `categories`: Lista opcional de categorias predefinidas

### ConfiguraÃ§Ãµes DisponÃ­veis

Principais variÃ¡veis de ambiente:

| VariÃ¡vel | DescriÃ§Ã£o | PadrÃ£o |
|----------|-----------|--------|
| `DATABASE_URL` | URL de conexÃ£o com o banco de dados | postgresql://postgres:postgres@localhost:5432/financial_docs |
| `KAFKA_BOOTSTRAP_SERVERS` | Servidores Kafka | localhost:9092 |
| `KAFKA_DOCUMENTS_TOPIC` | TÃ³pico para recebimento de documentos | documents-to-process |
| `KAFKA_PROCESSED_TOPIC` | TÃ³pico para documentos processados | processed-documents |
| `AI_PROVIDER` | Provedor de IA (openai, gemini, claude) | openai |
| `OPENAI_API_KEY` | Chave de API da OpenAI | - |
| `OPENAI_MODEL` | Modelo da OpenAI | gpt-4o |
| `GEMINI_API_KEY` | Chave de API do Gemini | - |
| `GEMINI_MODEL` | Modelo do Gemini | gemini-1.5-pro |
| `ANTHROPIC_API_KEY` | Chave de API da Anthropic | - |
| `CLAUDE_MODEL` | Modelo do Claude | claude-3-opus-20240229 |
| `LOG_LEVEL` | NÃ­vel de log | INFO |

## ğŸ“Š Fluxo de Processamento

1. **Recebimento**: Documento Ã© recebido via Kafka
2. **DecodificaÃ§Ã£o**: ConteÃºdo em Base64 Ã© decodificado e texto Ã© extraÃ­do 
3. **ExtraÃ§Ã£o**: IA extrai transaÃ§Ãµes do texto, identificando datas, valores, etc.
4. **CategorizaÃ§Ã£o**: TransaÃ§Ãµes sÃ£o categorizadas pela IA
5. **PersistÃªncia**: TransaÃ§Ãµes sÃ£o salvas no banco de dados
6. **NotificaÃ§Ã£o**: Mensagem de confirmaÃ§Ã£o Ã© enviada via Kafka

## ğŸ”„ Adaptadores de IA

O sistema suporta trÃªs provedores de IA:

### OpenAI

```bash
AI_PROVIDER=openai
OPENAI_API_KEY=sua_chave_aqui
OPENAI_MODEL=gpt-4o  # Ou gpt-3.5-turbo para menor custo
```

### Google Gemini

```bash
AI_PROVIDER=gemini
GEMINI_API_KEY=sua_chave_aqui
GEMINI_MODEL=gemini-1.5-pro  # Ou gemini-1.5-flash para menor custo
```

### Anthropic Claude

```bash
AI_PROVIDER=claude
ANTHROPIC_API_KEY=sua_chave_aqui
CLAUDE_MODEL=claude-3-opus-20240229  # Ou claude-3-haiku-20240307 para menor custo
```

## ğŸ“‰ EstratÃ©gias de OtimizaÃ§Ã£o de Custos

1. **Processamento em Lotes**: TransaÃ§Ãµes sÃ£o agrupadas para reduzir chamadas de API
2. **Templates de Prompts Otimizados**: Prompts especÃ­ficos para cada provedor
3. **Fallback Inteligente**: Usa modelos mais baratos quando possÃ­vel
4. **Caching**: Evita reprocessamento de padrÃµes comuns

## ğŸ” Monitoramento e Observabilidade

O serviÃ§o expÃµe vÃ¡rias mÃ©tricas Prometheus para monitoramento:

- `document_processed_total`: Contador de documentos processados (por tipo e status)
- `transaction_extracted_total`: Contador de transaÃ§Ãµes extraÃ­das (por tipo de documento)
- `document_processing_seconds`: Histograma de tempo de processamento
- `ai_api_calls_total`: Contador de chamadas de API de IA
- `ai_token_usage_total`: Contador de tokens consumidos
- `ai_cost_usd_total`: Contador de custos estimados em USD

MÃ©tricas podem ser acessadas em `http://localhost:8000/` quando o serviÃ§o estÃ¡ em execuÃ§Ã£o.

### Logs Estruturados

Os logs sÃ£o estruturados e incluem informaÃ§Ãµes detalhadas sobre cada etapa do processamento:

```
2023-05-10 14:35:22 | INFO     | financial_document_processor.main:handle_document:215 - Processando documento 12345 do tipo bank_statement
2023-05-10 14:35:25 | INFO     | financial_document_processor.services.document_processor:process:89 - Processamento do documento 12345 concluÃ­do em 3.21s. ExtraÃ­das 15 transaÃ§Ãµes.
```

## ğŸ—„ï¸ Banco de Dados e MigraÃ§Ãµes

O projeto utiliza SQLAlchemy e Alembic para gerenciar o esquema do banco de dados. As migraÃ§Ãµes estÃ£o localizadas no diretÃ³rio `migrations/`.

### Executando MigraÃ§Ãµes

Para configurar o banco de dados pela primeira vez:

```bash
# Aplicar todas as migraÃ§Ãµes
python scripts/db_migrate.py upgrade
```

### Gerenciando MigraÃ§Ãµes

Para criar uma nova migraÃ§Ã£o apÃ³s alterar modelos:

```bash
# Cria uma nova migraÃ§Ã£o com base nas alteraÃ§Ãµes nos modelos
python scripts/db_migrate.py create "DescriÃ§Ã£o da migraÃ§Ã£o"
```

Para reverter a Ãºltima migraÃ§Ã£o:

```bash
# Reverte a Ãºltima migraÃ§Ã£o aplicada
python scripts/db_migrate.py downgrade
```

Consulte `migrations/README.md` para mais detalhes sobre o sistema de migraÃ§Ãµes.

## ğŸ”„ CategorizaÃ§Ã£o de TransaÃ§Ãµes

O sistema utiliza uma combinaÃ§Ã£o de regras e IA para categorizar transaÃ§Ãµes em categorias como:

- Moradia (aluguel, luz, Ã¡gua, internet)
- AlimentaÃ§Ã£o (supermercado, restaurantes)
- Transporte (combustÃ­vel, transporte pÃºblico)
- SaÃºde (plano de saÃºde, farmÃ¡cia)
- EducaÃ§Ã£o (mensalidades, cursos)
- Lazer (viagens, entretenimento)

Para uma lista completa de categorias, consulte a [documentaÃ§Ã£o de categorias](docs/categories.md).

## ğŸ”§ Testes

Execute os testes com:

```bash
# Testes unitÃ¡rios
pytest tests/unit

# Testes de integraÃ§Ã£o
pytest tests/integration

# Verificar cobertura
pytest --cov=financial_document_processor
```

## ğŸ“ Exemplos de Uso

### Enviando um documento para processamento via Kafka

```python
import base64
import json
import uuid
from datetime import datetime
from kafka import KafkaProducer

# Configurar o produtor Kafka
producer = KafkaProducer(
    bootstrap_servers=['localhost:9092'],
    value_serializer=lambda v: json.dumps(v).encode('utf-8')
)

# Ler o arquivo e codificar em base64
with open('extrato.pdf', 'rb') as f:
    file_content = base64.b64encode(f.read()).decode('utf-8')

# Criar o payload
document = {
    "id": 12345,
    "external_id": str(uuid.uuid4()),
    "user_id": 98765,
    "document_type": "bank_statement",
    "filename": "extrato.pdf",
    "content_type": "application/pdf",
    "file_content": file_content,
    "categories": ["moradia", "alimentaÃ§Ã£o", "transporte"],
    "status": "pending",
    "created_at": datetime.now().isoformat(),
    "updated_at": datetime.now().isoformat()
}

# Enviar para o Kafka
producer.send('documents-to-process', document)
producer.flush()
print("Documento enviado para processamento!")
```

### Consumindo resultados do processamento

```python
import json
from kafka import KafkaConsumer

# Configurar o consumidor Kafka
consumer = KafkaConsumer(
    'processed-documents',
    bootstrap_servers=['localhost:9092'],
    auto_offset_reset='earliest',
    group_id='result-consumer',
    value_deserializer=lambda x: json.loads(x.decode('utf-8'))
)

# Consumir mensagens
for message in consumer:
    result = message.value
    print(f"Documento {result['document_id']} processado:")
    print(f"- Status: {result['status']}")
    print(f"- TransaÃ§Ãµes: {result.get('transaction_count', 0)}")
    
    if result['status'] == 'FAILED':
        print(f"- Erro: {result.get('error', 'Desconhecido')}")
```

## ğŸ“‹ Roadmap

- [x] Processamento de extratos bancÃ¡rios
- [ ] Suporte para notas fiscais
- [ ] Suporte para fatura de cartÃ£o de crÃ©dito
- [ ] API REST para consulta de transaÃ§Ãµes
- [ ] Dashboards de visualizaÃ§Ã£o
- [ ] ExportaÃ§Ã£o para sistemas contÃ¡beis
- [ ] Melhorias no modelo de categorizaÃ§Ã£o
- [ ] DetecÃ§Ã£o de fraudes e anomalias

## ğŸ¤ ContribuiÃ§Ã£o

1. Fork o projeto
2. Crie uma branch para sua feature (`git checkout -b feature/nova-feature`)
3. Commit suas mudanÃ§as (`git commit -m 'Adiciona nova feature'`)
4. Push para a branch (`git push origin feature/nova-feature`)
5. Abra um Pull Request

## ğŸ“œ LicenÃ§a

Este projeto estÃ¡ licenciado sob a [LicenÃ§a MIT](LICENSE).

## ğŸ“ Suporte

Para problemas, dÃºvidas ou sugestÃµes, por favor abra uma issue no GitHub ou entre em contato pelo email [seu.email@exemplo.com](mailto:seu.email@exemplo.com).

---

Feito com â¤ï¸ para tornar o processamento de documentos financeiros mais eficiente e inteligente.
